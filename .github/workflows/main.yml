name: Deploy MyApp

on:
  push:
    branches:
      - master   # ✅ use master instead of main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          script: |
            echo "🚀 Starting deployment with PM2..."

            APP_DIR="/var/www/html/myapp"

            # Load NVM so node/npm are available
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            export PATH="$NVM_DIR/versions/node/v16.20.2/bin:$PATH"

            # Clone repo if not exists
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "📥 Cloning fresh repository..."
              sudo rm -rf "$APP_DIR"
              git clone -b master ${{ secrets.REPO_URL }} "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "📦 Fetching latest code..."
            git fetch origin master
            git reset --hard origin/master

            echo "📦 Installing dependencies..."
            npm install --legacy-peer-deps

            echo "🧪 Running tests..."
            if npm run | grep -q "test"; then
              npm test -- --watchAll=false --passWithNoTests  || { echo "❌ Tests failed"; exit 1; }
            else
              echo "ℹ️ No test script found"
            fi

            echo "🏗️ Building app..."
            npm run build

            echo "🔄 Restarting PM2..."
            pm2 delete myapp || true
            pm2 start server.js --name myapp
            pm2 save

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: ⚠️ Rollback to previous commit
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          script: |
            echo "⚠️ Deployment failed. Rolling back to previous commit..."

            APP_DIR="/var/www/html/myapp"

            # Load NVM so node/npm are available
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            export PATH="$NVM_DIR/versions/node/v16.20.2/bin:$PATH"

            cd "$APP_DIR"

            # Rollback to previous commit
            git reset --hard HEAD~1
            git clean -fd
            echo "✅ Rollback successful to previous commit"

            npm install --legacy-peer-deps
            npm run build || true

            pm2 delete myapp || true
            pm2 start server.js --name myapp
            pm2 save

