name: Deploy Node.js App with Auto Rollback (PM2)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          script: |
            echo "üöÄ Starting deployment with PM2..."

            APP_DIR="/var/www/html/myapp"
            BACKUP_DIR="/var/www/html/myapp_backup"

            # Load NVM so node and npm are available
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            export PATH="$NVM_DIR/versions/node/v16.20.2/bin:$PATH"

            # Ensure app directory exists
            mkdir -p /var/www/html
            sudo chown -R ubuntu:ubuntu /var/www/html

            # Backup current app
            if [ -d "$APP_DIR" ]; then
              rm -rf "$BACKUP_DIR"
              cp -r "$APP_DIR" "$BACKUP_DIR" || { echo "‚ùå Backup failed"; exit 1; }
              echo "‚úÖ Backup saved at $BACKUP_DIR"
            fi

            # Clone repo
            rm -rf "$APP_DIR"
            git clone https://github.com/sidhant7510/project-githubaction.git "$APP_DIR"
            cd "$APP_DIR"

            echo "üì¶ Installing dependencies..."
            npm install --legacy-peer-deps

            echo "üèóÔ∏è Building project..."
            if npm run | grep -q "build"; then
              npm run build
            else
              echo "‚ÑπÔ∏è No build script found"
              mkdir -p build
              cp -r . build/ || true
            fi

            echo "üß™ Running tests..."
            if npm run | grep -q "test"; then
              npm test -- --watchAll=false --passWithNoTests || { echo "‚ùå Tests failed"; exit 1; }
            else
              echo "‚ÑπÔ∏è No test script found"
            fi

            echo "üöÄ Restarting app with PM2..."
            pm2 delete myapp || true
            pm2 start server.js --name myapp
            pm2 save
            echo "‚úÖ Deployment finished"

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Rollback on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          script: |
            echo "‚ö†Ô∏è Deployment failed. Rolling back..."
            APP_DIR="/var/www/html/myapp"
            BACKUP_DIR="/var/www/html/myapp_backup"

            # Load NVM so node/npm are available
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            export PATH="$NVM_DIR/versions/node/v16.20.2/bin:$PATH"

            if [ -d "$BACKUP_DIR" ]; then
              rm -rf "$APP_DIR"
              cp -r "$BACKUP_DIR" "$APP_DIR"
              echo "‚úÖ Rollback restored from $BACKUP_DIR"

              cd "$APP_DIR"
              pm2 delete myapp || true
              pm2 start server.js --name myapp
              pm2 save
            else
              echo "‚ùå No backup found. Manual recovery needed."
              exit 1
            fi

